<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>📸 Auto Gemini Vision → Telegram</title>
</head>
<body>
  <h2>📷 Auto-Capture → Gemini (Image) → Telegram</h2>

  <video id="video" autoplay playsinline style="width:100%;border:1px solid #000;"></video>

  <!-- Optional: camera switch -->
  <div>
    <button id="switchCamera">🔄 Switch Camera</button>
  </div>

  <pre id="log"></pre>

  <script>
   const GEMINI_API_KEY = "AIzaSyD6tSpHZBioYNcIPsJ2BLf2hhniyIFYb9s";
    const TELEGRAM_BOT_TOKEN = "8241568142:AAG-mtJeGRL-YzCd_M_r3F1FbteDLeOrVO8";
    const TELEGRAM_CHAT_ID = "7225122599";

    const video = document.getElementById("video");
    const log = document.getElementById("log");
    const switchBtn = document.getElementById("switchCamera");

    let currentFacingMode = "environment";
    let currentStream = null;

    async function startCamera() {
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
      }

      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { exact: currentFacingMode } }
        });
        currentStream = stream;
        video.srcObject = stream;
      } catch (err) {
        log.innerText = "Camera error: " + err;
      }
    }

    switchBtn.addEventListener("click", () => {
      currentFacingMode = currentFacingMode === "environment" ? "user" : "environment";
      startCamera();
    });

    async function captureAndSend() {
      log.innerText = "📸 Capturing image...";

      const canvas = document.createElement("canvas");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0);
      const dataURL = canvas.toDataURL("image/jpeg");
      const base64Image = dataURL.replace(/^data:image\/jpeg;base64,/, "");

      log.innerText = "🧠 Sending image to Gemini...";

      const geminiRes = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro-vision:generateContent?key=${GEMINI_API_KEY}`,
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            contents: [
              {
                parts: [
                  { text: "What is shown in this image? Provide a clear description." },
                  {
                    inlineData: {
                      mimeType: "image/jpeg",
                      data: base64Image
                    }
                  }
                ]
              }
            ]
          })
        }
      );

      const geminiData = await geminiRes.json();
      const answer = geminiData?.candidates?.[0]?.content?.parts?.[0]?.text || "⚠️ No response from Gemini";

      log.innerText = "🤖 Gemini response:\n" + answer;

      // Send to Telegram
      log.innerText += "\n📩 Sending to Telegram...";
      await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          chat_id: TELEGRAM_CHAT_ID,
          text: answer
        })
      });

      log.innerText += "\n✅ Sent to Telegram!";
    }

    // Start everything
    startCamera();

    // Auto capture every 15 seconds
    setInterval(() => {
      captureAndSend();
    }, 15000); // 15,000 ms = 15 seconds
  </script>
</body>
</html>
